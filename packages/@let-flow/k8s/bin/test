#!/usr/bin/env python
from urllib.parse import quote_plus
import os
from pymongo import MongoClient
import psycopg2
import redis
import meo
from pydantic import BaseModel


class Service(BaseModel):
    host: str
    port: int
    user: str | None
    password: str | None


class Config(BaseModel):
    redis: Service
    mongodb: Service
    postgresql: Service


config = Config(**meo.load_json(
    os.path.join(
        meo.utils.script_path(__file__),
        "../config.json",
    )
)['development'])


def pick(obj, *keys):
    return {k: obj[k] for k in keys if k in obj}


r = redis.StrictRedis(
    host=config.redis.host,
    port=config.redis.port,
)
r.set("test", 1212, ex=10)
print("✨ Redis is ready ✨")

conn = psycopg2.connect(
    host=config.postgresql.host,
    port=config.postgresql.port,
    user=config.postgresql.user,
    password=config.postgresql.password,
)
conn.close()
print("✨ Postgres is ready ✨")


uri = "mongodb://%s:%s@%s" % (
    quote_plus(config.mongodb.user), quote_plus(config.mongodb.password), config.mongodb.host)
client = MongoClient(uri, serverSelectionTimeoutMS=2000)
db_version = client.server_info()
print("✨ MongoDB is ready ✨")
